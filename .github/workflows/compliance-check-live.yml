# ---------------------------------------------------------------------------
# Eckohaus Orchestration Pilot
# Compliance Check (Companies House - Live)
# ---------------------------------------------------------------------------
# Runs manually or via schedule to query the Companies House API for live
# company data, archive responses, and update orchestration-ledger.md.
# ---------------------------------------------------------------------------

name: Compliance Check (Companies House - Live)

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: "0 10 * * 1"  # Every Monday at 10:00 UTC (weekly live check)

permissions:
  contents: write  # allow workflow to commit ledger updates

jobs:
  check-company-status:
    name: Query Companies House (Live)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load metadata
        id: metadata
        run: |
          echo "ðŸ“¦ Loading metadata from config/metadata.yml"
          # Extract and sanitize YAML values (remove quotes / trim whitespace)
          COMPANY_NAME=$(grep '^name:' config/metadata.yml | sed -E "s/name:[[:space:]]*['\"]?(.*)['\"]?/\1/")
          COMPANY_NUMBER=$(grep '^company_number:' config/metadata.yml | sed -E "s/company_number:[[:space:]]*['\"]?([0-9A-Za-z]+)['\"]?/\1/")

          # Debugging visibility
          echo "Debug â†’ COMPANY_NAME: '$COMPANY_NAME'"
          echo "Debug â†’ COMPANY_NUMBER: '$COMPANY_NUMBER'"

          # Export to GITHUB_OUTPUT
          echo "company_name=$COMPANY_NAME" >> $GITHUB_OUTPUT
          echo "company_number=$COMPANY_NUMBER" >> $GITHUB_OUTPUT

          echo "âœ… Loaded company: $COMPANY_NAME ($COMPANY_NUMBER)"

      - name: Query Companies House API (Live)
        id: ch_query
        env:
          CH_API_KEY: ${{ secrets.CH_API_KEY_LIVE }}
          COMPANY_NUMBER: ${{ steps.metadata.outputs.company_number }}
        run: |
          echo "ðŸ” Querying Companies House LIVE API for company $COMPANY_NUMBER"

          # Fail-fast guard: exit cleanly if API key not set
          if [ -z "$CH_API_KEY" ]; then
            echo "âŒ No API key detected â€” skipping this run safely."
            exit 0
          fi

          AUTH_HEADER=$(echo -n "$CH_API_KEY:" | base64)
          curl -s -w "%{http_code}" -H "Authorization: Basic $AUTH_HEADER" \
               "https://api.company-information.service.gov.uk/company/$COMPANY_NUMBER" \
               -o response_live.json > status_code.txt
          STATUS_CODE=$(cat status_code.txt)
          echo "HTTP status: $STATUS_CODE"
          echo "status=$STATUS_CODE" >> $GITHUB_OUTPUT

      - name: Conditional weekday retry on 404 (UK hours)
        if: steps.ch_query.outputs.status == '404'
        env:
          CH_API_KEY: ${{ secrets.CH_API_KEY_LIVE }}
          COMPANY_NUMBER: ${{ steps.metadata.outputs.company_number }}
        run: |
          # Retry only during UK business hours (Monâ€“Fri, 09:00â€“17:00 UTC)
          UK_HOUR=$(date -u +"%H")
          UK_DAY=$(date -u +"%u")  # 1=Mon â€¦ 7=Sun
          if [ "$UK_DAY" -ge 1 ] && [ "$UK_DAY" -le 5 ] && [ "$UK_HOUR" -ge 9 ] && [ "$UK_HOUR" -lt 17 ]; then
            echo "ðŸ•’ Within UK business hours; waiting 30 minutes then retryingâ€¦"
            sleep 1800
            AUTH_HEADER=$(echo -n "$CH_API_KEY:" | base64)
            curl -s -H "Authorization: Basic $AUTH_HEADER" \
                 "https://api.company-information.service.gov.uk/company/$COMPANY_NUMBER" \
                 -o response_live.json
            echo "âœ… Retried query complete"
          else
            echo "ðŸ•“ Outside UK business hours â€” skipping retry until next run."
          fi

      - name: Display response
        run: |
          echo "ðŸ“„ Companies House LIVE API response:"
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          jq . response_live.json || cat response_live.json

      - name: Store response for audit trail
        if: always()
        run: |
          mkdir -p data/responses
          TIMESTAMP=$(date +'%Y%m%d_%H%M')
          cp response_live.json "data/responses/response_live_${TIMESTAMP}.json"
          echo "ðŸ—‚ï¸ Response archived at data/responses/response_live_${TIMESTAMP}.json"

      - name: Append summary to orchestration-ledger.md
        if: success()
        run: |
          TS=$(date -u +'%Y-%m-%d %H:%M UTC')
          FILE="data/responses/response_live_$(date +'%Y%m%d_%H%M').json"
          echo "| ${TS} | Weekly CH live check | Archived ${FILE} | CH live API |" >> orchestration-ledger.md
          echo "âœ… Ledger updated"

      - name: Commit ledger update
        if: success()
        env:
          GIT_AUTHOR_NAME: "Eckohaus Bot"
          GIT_AUTHOR_EMAIL: "info@eckohaus.co.uk"
          GIT_COMMITTER_NAME: "Eckohaus Bot"
          GIT_COMMITTER_EMAIL: "info@eckohaus.co.uk"
        run: |
          git add orchestration-ledger.md data/responses/*.json || true
          git commit -m "Weekly CH live check: archive + ledger update" \
            -m "Co-authored-by: system operator <wanda@openai.com>" \
            -m "Co-authored-by: system administrator <Corvin Nehal Dhali> <info@eckohaus.co.uk>" || echo "No changes to commit"
          git push || true

# ---------------------------------------------------------------------------
# Co-authored-by: system operator <wanda@openai.com>
# Co-authored-by: system administrator <Corvin Nehal Dhali> <info@eckohaus.co.uk>
# ---------------------------------------------------------------------------

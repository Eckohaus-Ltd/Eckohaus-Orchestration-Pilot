name: Compliance Check (Companies House - Sandbox)

on:
  workflow_dispatch:  # Manual trigger via Actions tab
  schedule:
    - cron: "0 10 * * 1"  # Runs every Monday at 10:00 UTC for periodic checks

jobs:
  check-company-status:
    name: Query Companies House (Sandbox)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load metadata
        id: metadata
        run: |
          echo "Loading metadata from config/metadata.yml"
          COMPANY_NAME=$(grep 'name:' config/metadata.yml | awk '{print $2" "$3}')
          COMPANY_NUMBER=$(grep 'company_number:' config/metadata.yml | awk '{print $2}')
          echo "company_name=$COMPANY_NAME" >> $GITHUB_OUTPUT
          echo "company_number=$COMPANY_NUMBER" >> $GITHUB_OUTPUT
          echo "‚úÖ Loaded company: $COMPANY_NAME ($COMPANY_NUMBER)"

      - name: Query Companies House API (Sandbox)
        id: ch_query
        env:
          CH_API_KEY: ${{ secrets.CH_API_KEY }}
          COMPANY_NUMBER: ${{ steps.metadata.outputs.company_number }}
        run: |
          echo "üîç Querying Companies House Sandbox API for company $COMPANY_NUMBER"

          AUTH_HEADER=$(echo -n "$CH_API_KEY:" | base64)
          curl -s -H "Authorization: Basic $AUTH_HEADER" \
               "https://api-sandbox.company-information.service.gov.uk/company/$COMPANY_NUMBER" \
               -o response.json

          if [ ! -s response.json ]; then
            echo "‚ùå No response received or file empty."
            exit 1
          fi

          echo "‚úÖ Sandbox response saved to response.json"

      - name: Display sandbox response
        run: |
          echo "üìÑ Companies House API response:"
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          jq . response.json || cat response.json

      - name: Store sandbox response for audit trail
        if: always()
        run: |
          mkdir -p data/responses
          TIMESTAMP=$(date +'%Y%m%d_%H%M')
          cp response.json "data/responses/response_sandbox_${TIMESTAMP}.json"
          echo "üóÇÔ∏è Response archived at data/responses/response_sandbox_${TIMESTAMP}.json"

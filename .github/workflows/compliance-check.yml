# ---------------------------------------------------------------------------
# Eckohaus Orchestration Pilot
# Compliance Check (Companies House - Sandbox/Test)
# ---------------------------------------------------------------------------
# Used for testing Companies House API integration logic safely in the
# sandbox environment before live deployment. Archives mock responses and
# appends summaries to orchestration-ledger.md.
# ---------------------------------------------------------------------------

name: Compliance Check (Companies House - Sandbox)

on:
  workflow_dispatch:  # Run manually from Actions tab
  # schedule:
  #   - cron: "0 9 * * 1"  # Optional: enable for scheduled sandbox tests

permissions:
  contents: write  # allow workflow to update the ledger

jobs:
  check-company-status-sandbox:
    name: Query Companies House (Sandbox)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load metadata
        id: metadata
        run: |
          echo "ðŸ“¦ Loading metadata from config/metadata.yml"

          # Extract nested YAML values from `company:` block
          COMPANY_NAME=$(grep 'name:' config/metadata.yml | head -1 | sed -E "s/.*name:[[:space:]]*['\"]?([^'\"]+)['\"]?/\1/")
          COMPANY_NUMBER=$(grep 'company_number:' config/metadata.yml | head -1 | sed -E "s/.*company_number:[[:space:]]*['\"]?([^'\"]+)['\"]?/\1/")
          API_ENVIRONMENT=$(grep 'api_environment:' config/metadata.yml | head -1 | sed -E "s/.*api_environment:[[:space:]]*['\"]?([^'\"]+)['\"]?/\1/")
          API_SECRET_REF=$(grep 'api_secret_ref:' config/metadata.yml | head -1 | sed -E "s/.*api_secret_ref:[[:space:]]*['\"]?([^'\"]+)['\"]?/\1/")

          # Debugging visibility
          echo "Debug â†’ COMPANY_NAME: '$COMPANY_NAME'"
          echo "Debug â†’ COMPANY_NUMBER: '$COMPANY_NUMBER'"
          echo "Debug â†’ API_ENVIRONMENT: '$API_ENVIRONMENT'"
          echo "Debug â†’ API_SECRET_REF: '$API_SECRET_REF'"

          # Export to GITHUB_OUTPUT
          echo "company_name=$COMPANY_NAME" >> $GITHUB_OUTPUT
          echo "company_number=$COMPANY_NUMBER" >> $GITHUB_OUTPUT
          echo "api_environment=$API_ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "api_secret_ref=$API_SECRET_REF" >> $GITHUB_OUTPUT

          echo "âœ… Loaded company: $COMPANY_NAME ($COMPANY_NUMBER) â€” Env: $API_ENVIRONMENT"

      - name: Query Companies House API (Sandbox)
        id: ch_query
        env:
          CH_API_KEY: ${{ secrets.CH_API_KEY }}
          COMPANY_NUMBER: ${{ steps.metadata.outputs.company_number }}
        run: |
          echo "ðŸ” Querying Companies House SANDBOX API for test company $COMPANY_NUMBER"

          # Fail-fast guard: exit cleanly if API key not set
          if [ -z "$CH_API_KEY" ]; then
            echo "âŒ No sandbox API key detected â€” skipping this run safely."
            exit 0
          fi

          AUTH_HEADER=$(echo -n "$CH_API_KEY:" | base64)
          curl -s -w "%{http_code}" -H "Authorization: Basic $AUTH_HEADER" \
               "https://api-sandbox.company-information.service.gov.uk/company/$COMPANY_NUMBER" \
               -o response_sandbox.json > status_code.txt
          STATUS_CODE=$(cat status_code.txt)
          echo "HTTP status: $STATUS_CODE"
          echo "status=$STATUS_CODE" >> $GITHUB_OUTPUT

      - name: Display response
        run: |
          echo "ðŸ“„ Companies House SANDBOX API response:"
          sudo apt-get update -qq && sudo apt-get install -y jq -qq
          jq . response_sandbox.json || cat response_sandbox.json

      - name: Store response for audit trail
        if: always()
        run: |
          mkdir -p data/sandbox_responses
          TIMESTAMP=$(date +'%Y%m%d_%H%M')
          cp response_sandbox.json "data/sandbox_responses/response_sandbox_${TIMESTAMP}.json"
          echo "ðŸ—‚ï¸ Sandbox response archived at data/sandbox_responses/response_sandbox_${TIMESTAMP}.json"

      - name: Create workflow analysis artifacts
        if: always()
        run: |
          echo "ðŸ“Š Creating workflow analysis artifacts..."
          mkdir -p analysis-output
          
          # Capture repository structure
          echo "=== Repository Structure ===" > analysis-output/repository-structure.txt
          tree -L 3 -a --gitignore || find . -maxdepth 3 -not -path '*/\.*' | sort >> analysis-output/repository-structure.txt
          
          # Branch and commit information
          echo "" >> analysis-output/repository-structure.txt
          echo "=== Branch Information ===" >> analysis-output/repository-structure.txt
          git branch -a >> analysis-output/repository-structure.txt
          echo "" >> analysis-output/repository-structure.txt
          echo "=== Current Commit ===" >> analysis-output/repository-structure.txt
          git log -1 --pretty=format:"Commit: %H%nAuthor: %an <%ae>%nDate: %ad%nMessage: %s" >> analysis-output/repository-structure.txt
          
          # Workflow execution metadata
          cat > analysis-output/workflow-metadata.json << EOF
          {
            "workflow": "Compliance Check (Companies House - Sandbox)",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "actor": "${{ github.actor }}",
            "event": "${{ github.event_name }}",
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "repository": "${{ github.repository }}",
            "company_number": "${{ steps.metadata.outputs.company_number }}",
            "api_environment": "sandbox",
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          }
          EOF
          
          # Copy response for artifact
          cp response_sandbox.json analysis-output/ 2>/dev/null || true
          cp status_code.txt analysis-output/ 2>/dev/null || true
          
          echo "âœ… Analysis artifacts created"

      - name: Upload workflow artifacts for analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compliance-sandbox-${{ github.run_number }}
          path: |
            analysis-output/
            data/sandbox_responses/response_sandbox_*.json
          retention-days: 90

      - name: Append summary to orchestration-ledger.md
        if: success()
        run: |
          TS=$(date -u +'%Y-%m-%d %H:%M UTC')
          FILE="data/sandbox_responses/response_sandbox_$(date +'%Y%m%d_%H%M').json"
          echo "| ${TS} | Sandbox CH test check | Archived ${FILE} | CH sandbox API |" >> orchestration-ledger.md
          echo "âœ… Ledger updated (sandbox entry appended)"

      - name: Commit ledger update
        if: success()
        env:
          GIT_AUTHOR_NAME: "Eckohaus Bot"
          GIT_AUTHOR_EMAIL: "info@eckohaus.co.uk"
          GIT_COMMITTER_NAME: "Eckohaus Bot"
          GIT_COMMITTER_EMAIL: "info@eckohaus.co.uk"
        run: |
          git add orchestration-ledger.md data/sandbox_responses/*.json || true
          git commit -m "fix(metadata): add nested YAML parser for sandbox orchestration" \
            -m "Ensures COMPANY_NAME, COMPANY_NUMBER, API_ENVIRONMENT, and API_SECRET_REF are correctly parsed from nested company: block." \
            -m "Co-authored-by: system operator <wanda@openai.com>" \
            -m "Co-authored-by: system administrator <Corvin Nehal Dhali> <info@eckohaus.co.uk>" || echo "No changes to commit"
          git push || true

# ---------------------------------------------------------------------------
# Co-authored-by: system operator <wanda@openai.com>
# Co-authored-by: system administrator <Corvin Nehal Dhali> <info@eckohaus.co.uk>
# ---------------------------------------------------------------------------
